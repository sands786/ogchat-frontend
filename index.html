<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OG Verifiable Chat — Powered by OpenGradient</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #111118;
      --surface2: #1a1a24;
      --border: #2a2a3a;
      --accent: #7c6cfc;
      --accent2: #00e5c0;
      --text: #e8e8f0;
      --text-muted: #6b6b80;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; -webkit-font-smoothing: antialiased; }
    ::selection { background: var(--accent); color: white; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    .app { display: flex; flex-direction: column; height: 100vh; }
    .header { display: flex; align-items: center; justify-content: space-between; padding: 0 24px; height: 60px; border-bottom: 1px solid var(--border); background: var(--surface); flex-shrink: 0; gap: 16px; }
    .logo { display: flex; align-items: center; gap: 8px; }
    .logo-icon { font-size: 20px; color: var(--accent); }
    .logo-text { font-weight: 800; font-size: 16px; letter-spacing: -0.02em; }
    .badge { font-family: 'Space Mono', monospace; font-size: 10px; padding: 3px 8px; border: 1px solid var(--accent); color: var(--accent); border-radius: 20px; text-transform: uppercase; letter-spacing: 0.05em; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .powered-by { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-muted); text-decoration: none; }
    .powered-by:hover { color: var(--accent2); }
    .model-selector { display: flex; gap: 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 3px; }
    .model-btn { font-family: 'Space Mono', monospace; font-size: 11px; padding: 5px 10px; border: none; background: transparent; color: var(--text-muted); border-radius: 6px; cursor: pointer; transition: all 0.15s; }
    .model-btn:hover { color: var(--text); background: var(--surface2); }
    .model-btn.active { background: var(--accent); color: white; }
    .main { flex: 1; overflow-y: auto; padding: 24px; }
    .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 200px); text-align: center; gap: 20px; }
    .empty-icon { font-size: 56px; color: var(--accent); filter: drop-shadow(0 0 24px rgba(124,108,252,0.4)); }
    .empty-title { font-weight: 800; font-size: clamp(28px, 5vw, 48px); letter-spacing: -0.03em; background: linear-gradient(135deg, var(--text) 0%, var(--accent) 50%, var(--accent2) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .empty-desc { font-size: 15px; color: var(--text-muted); max-width: 500px; line-height: 1.7; }
    .empty-desc strong { color: var(--accent2); }
    .features { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
    .feature { display: flex; align-items: center; gap: 8px; font-family: 'Space Mono', monospace; font-size: 12px; color: var(--text-muted); }
    .feature-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .starters { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .starter { font-family: 'Space Mono', monospace; font-size: 12px; padding: 8px 16px; background: var(--surface); border: 1px solid var(--border); color: var(--text-muted); border-radius: 8px; cursor: pointer; transition: all 0.15s; }
    .starter:hover { border-color: var(--accent); color: var(--text); }
    .messages { display: flex; flex-direction: column; gap: 20px; max-width: 760px; margin: 0 auto; }
    .message-row { display: flex; gap: 12px; animation: fadeUp 0.25s ease both; }
    .message-row.user { flex-direction: row-reverse; }
    .avatar { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; flex-shrink: 0; background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); }
    .message-row.ai .avatar { background: linear-gradient(135deg, var(--accent), var(--accent2)); border-color: transparent; color: white; font-size: 16px; }
    .bubble { max-width: 70%; }
    .message-row.user .bubble { background: #1e1e2e; border: 1px solid var(--border); border-radius: 16px 4px 16px 16px; padding: 12px 16px; }
    .message-row.ai .bubble { background: #141420; border: 1px solid var(--border); border-radius: 4px 16px 16px 16px; padding: 12px 16px; }
    .msg-content { font-size: 15px; line-height: 1.65; white-space: pre-wrap; word-break: break-word; }
    .typing { display: flex; gap: 4px; align-items: center; color: var(--accent); font-size: 10px; padding: 4px 0; }
    .typing span { animation: blink 1.2s infinite; }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    .receipt { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
    .receipt-label { display: flex; align-items: center; gap: 6px; font-family: 'Space Mono', monospace; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .receipt-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent2); box-shadow: 0 0 6px var(--accent2); }
    .tx-hash { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--accent); text-decoration: none; }
    .tx-hash:hover { color: var(--accent2); }
    .model-tag { font-family: 'Space Mono', monospace; font-size: 10px; padding: 2px 6px; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--text-muted); }
    .error-banner { margin: 0 24px 8px; padding: 10px 16px; background: rgba(252,108,108,0.1); border: 1px solid rgba(252,108,108,0.3); border-radius: 8px; font-family: 'Space Mono', monospace; font-size: 12px; color: #fc6c6c; display: flex; justify-content: space-between; align-items: center; }
    .error-banner button { background: none; border: none; color: #fc6c6c; cursor: pointer; font-size: 14px; }
    .hidden { display: none; }
    .footer { flex-shrink: 0; padding: 12px 24px 16px; border-top: 1px solid var(--border); background: var(--surface); }
    .input-container { display: flex; gap: 10px; align-items: flex-end; max-width: 760px; margin: 0 auto; }
    .input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; color: var(--text); font-family: 'Syne', sans-serif; font-size: 15px; resize: none; outline: none; transition: border-color 0.15s; line-height: 1.5; }
    .input:focus { border-color: var(--accent); }
    .input::placeholder { color: var(--text-muted); }
    .send-btn { width: 44px; height: 44px; border-radius: 10px; background: var(--accent); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; flex-shrink: 0; }
    .send-btn:hover:not(:disabled) { background: #6a5ce8; transform: scale(1.05); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .footer-note { text-align: center; font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-muted); margin-top: 10px; }
    .footer-note a { color: var(--accent2); text-decoration: none; }
    .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <span class="logo-icon">⬡</span>
          <span class="logo-text">OG Chat</span>
        </div>
        <div class="badge">Verifiable AI</div>
      </div>
      <div class="model-selector">
        <button class="model-btn active" data-model="openai/gpt-4o">GPT-4o</button>
        <button class="model-btn" data-model="anthropic/claude-3-5-haiku">Claude Haiku</button>
        <button class="model-btn" data-model="google/gemini-2-0-flash">Gemini Flash</button>
      </div>
      <div class="header-right">
        <a href="https://opengradient.ai" target="_blank" class="powered-by">Powered by OpenGradient ↗</a>
      </div>
    </header>

    <main class="main" id="main">
      <div class="empty" id="empty">
        <div class="empty-icon">⬡</div>
        <h1 class="empty-title">Verifiable AI Chat</h1>
        <p class="empty-desc">Every response is executed on OpenGradient's decentralized network. Each message comes with a <strong>blockchain receipt</strong>.</p>
        <div class="features">
          <div class="feature"><span class="feature-dot" style="background:var(--accent)"></span>On-chain verified inference</div>
          <div class="feature"><span class="feature-dot" style="background:var(--accent2)"></span>TEE-secured execution</div>
          <div class="feature"><span class="feature-dot" style="background:#fc6c6c"></span>Tamper-proof receipts</div>
        </div>
        <div class="starters">
          <button class="starter" onclick="setInput('Explain verifiable AI in simple terms')">Explain verifiable AI in simple terms</button>
          <button class="starter" onclick="setInput('What makes OpenGradient unique?')">What makes OpenGradient unique?</button>
          <button class="starter" onclick="setInput('What is blockchain in one sentence?')">What is blockchain in one sentence?</button>
        </div>
      </div>
      <div class="messages hidden" id="messages"></div>
    </main>

    <div class="error-banner hidden" id="error-banner">
      <span id="error-text"></span>
      <button onclick="hideError()">✕</button>
    </div>

    <footer class="footer">
      <div class="input-container">
        <textarea id="input" class="input" placeholder="Send a message… (Enter to send, Shift+Enter for newline)" rows="1"></textarea>
        <button class="send-btn" id="send-btn" onclick="send()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
      <p class="footer-note">Responses verified on <a href="https://explorer.opengradient.ai" target="_blank">OpenGradient Network</a></p>
    </footer>
  </div>

  <script>
    const BACKEND = "https://og-chat-backend-production.up.railway.app";
    let messages = [];
    let loading = false;
    let selectedModel = "openai/gpt-4o";

    document.querySelectorAll(".model-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".model-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedModel = btn.dataset.model;
      });
    });

    document.getElementById("input").addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
    });

    function setInput(text) {
      document.getElementById("input").value = text;
      document.getElementById("input").focus();
    }

    function hideError() {
      document.getElementById("error-banner").classList.add("hidden");
    }

    function showError(msg) {
      document.getElementById("error-text").textContent = "⚠ " + msg;
      document.getElementById("error-banner").classList.remove("hidden");
    }

    function setLoading(val) {
      loading = val;
      const btn = document.getElementById("send-btn");
      btn.disabled = val;
      btn.innerHTML = val
        ? '<span class="spinner"></span>'
        : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>';
    }

    function renderMessages() {
      const container = document.getElementById("messages");
      const empty = document.getElementById("empty");
      if (messages.length === 0) {
        empty.classList.remove("hidden");
        container.classList.add("hidden");
        return;
      }
      empty.classList.add("hidden");
      container.classList.remove("hidden");
      container.innerHTML = messages.map(msg => {
        if (msg.pending) {
          return `<div class="message-row ai">
            <div class="avatar">⬡</div>
            <div class="bubble">
              <div class="typing"><span>●</span><span>●</span><span>●</span></div>
            </div>
          </div>`;
        }
        const isUser = msg.role === "user";
        const receipt = (!isUser && msg.txHash) ? `
          <div class="receipt">
            <div class="receipt-label"><span class="receipt-dot"></span>On-chain receipt</div>
            <a href="https://explorer.opengradient.ai/tx/${msg.txHash}" target="_blank" class="tx-hash">
              ${msg.txHash.slice(0,10)}...${msg.txHash.slice(-8)} ↗
            </a>
            ${msg.model ? `<span class="model-tag">${msg.model.split("/")[1] || msg.model}</span>` : ""}
          </div>` : "";
        return `<div class="message-row ${isUser ? "user" : "ai"}">
          <div class="avatar">${isUser ? "U" : "⬡"}</div>
          <div class="bubble">
            <div class="msg-content">${msg.content.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
            ${receipt}
          </div>
        </div>`;
      }).join("");
      document.getElementById("main").scrollTop = document.getElementById("main").scrollHeight;
    }

    async function send() {
      const inputEl = document.getElementById("input");
      const text = inputEl.value.trim();
      if (!text || loading) return;
      hideError();

      // Add user message
      messages.push({ role: "user", content: text });
      messages.push({ pending: true });
      inputEl.value = "";
      setLoading(true);
      renderMessages();

      // FIX: Send ALL non-pending messages including the current user message
      const history = messages.filter(m => !m.pending).map(({ role, content }) => ({ role, content }));

      try {
        const res = await fetch(`${BACKEND}/api/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: history, model: selectedModel }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || data.error || "Something went wrong");
        messages.pop(); // remove pending
        messages.push({ role: "assistant", content: data.content, txHash: data.payment_hash, model: data.model });
      } catch (e) {
        messages.pop(); // remove pending
        showError(e.message || "Unknown error");
      } finally {
        setLoading(false);
        renderMessages();
        inputEl.focus();
      }
    }

    renderMessages();
  </script>
</body>
</html>
